"use strict";
/**
 *
 * !!! DO NOT MODIFY THIS FILE FOR STUPID REASONS !!!
 * @author leydev
 *
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.Manager = void 0;
const events_1 = require("events");
const uuid_1 = require("uuid");
class Manager extends events_1.EventEmitter {
    constructor(websocket) {
        super();
        this.websocket = websocket;
        this.websocket.on("error", (error) => console.error(error));
        this.websocket.on("connection", (socket, req) => {
            Object.assign(socket, { uuid: (0, uuid_1.v4)() });
            console.log(`\n\nâœ¨ New client: ${socket.uuid} from ${req.socket.remoteAddress}`);
            socket.on("close", () => console.log(`Client ${socket.uuid} closed conection.`));
            socket.on("message", (message) => {
                let payload = { type: "", msg: undefined };
                try {
                    payload = Manager.decodePayload(message);
                }
                catch (error) {
                    console.error(error);
                    socket.send(`Unknown command: ${message.toString()}`);
                }
                super.emit(payload.type, payload.msg, socket.uuid);
            });
        });
    }
    static decodePayload(message) {
        const payload = JSON.parse(message.toString());
        if (payload.type || payload.type && payload.msg)
            return payload;
        throw new Error(`Wrong payload. Expected {type: string, msg: any} recived: {${payload.type}, ${payload.msg}}`);
    }
    static encodePayload(data) {
        return JSON.stringify(data);
    }
    /**
     * Send a message to all connected clients
     *
     * @example
     * manager.sendBroadcast("CHANNEL", { data: "test" })
     */
    sendBroadcast(type, msg, uuid) {
        const payload = Manager.encodePayload({ type: type, msg });
        this.websocket.clients.forEach((client) => {
            if (client.uuid === uuid)
                return;
            client.send(payload);
        });
    }
    /**
     * Send a message to specific client based in UUID
     *
     * @example
     * manager.send("CHANNEL", { data: "test" }, "UUID")
     */
    send(type, msg, uuid) {
        const payload = Manager.encodePayload({ type: type, msg });
        const client = Array.from(this.websocket.clients).find((client) => client.uuid === uuid);
        if (client) {
            client.send(payload);
            return true;
        }
        return false;
    }
    /**
     * Wait for message in spacific channel
     *
     * @example
     * manager.on("CHANNEL", (context: Context, msg) => void)
     */
    on(eventName, listener) {
        const callback = (msg, uuid) => listener({
            sendBroadcast: (type, msg) => this.sendBroadcast(type, msg, uuid),
            send: (type, msg, uuid) => this.send(type, msg, uuid),
            originId: uuid
        }, msg);
        return super.on(eventName, callback);
    }
}
exports.Manager = Manager;
exports.default = Manager;

//# sourceMappingURL=data:application/json;charset=utf8;base64,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Q0FDRjtBQS9GRCwwQkErRkM7QUFFRCxrQkFBZSxPQUFPLENBQUMiLCJmaWxlIjoibWFuYWdlci9pbmRleC5qcyIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBcclxuICogISEhIERPIE5PVCBNT0RJRlkgVEhJUyBGSUxFIEZPUiBTVFVQSUQgUkVBU09OUyAhISFcclxuICogQGF1dGhvciBsZXlkZXZcclxuICogXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiXHJcbmltcG9ydCB7IHY0IGFzIHV1aWR2NCB9IGZyb20gXCJ1dWlkXCJcclxuaW1wb3J0IFdTIGZyb20gXCJ3c1wiXHJcblxyXG5pbXBvcnQgeyBDb250ZXh0LCBFdmVudHMsIFBheWxvYWQgfSBmcm9tIFwiLi90eXBlcy9jb3JlXCJcclxuaW1wb3J0IHsgUmVxdWVzdHMgfSBmcm9tIFwiLi90eXBlcy9yZXF1ZXN0XCJcclxuaW1wb3J0IHsgUmVzcG9uc2VzIH0gZnJvbSBcIi4vdHlwZXMvcmVzcG9uc2VcIlxyXG5cclxuZXhwb3J0IGNsYXNzIE1hbmFnZXI8UmVxIGV4dGVuZHMgRXZlbnRzID0gUmVxdWVzdHMsIFJlcyBleHRlbmRzIEV2ZW50cyA9IFJlc3BvbnNlcz4gZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xyXG4gIHByaXZhdGUgd2Vic29ja2V0OiBXUy5TZXJ2ZXJcclxuXHJcbiAgY29uc3RydWN0b3Iod2Vic29ja2V0OiBXUy5TZXJ2ZXIpIHtcclxuICAgIHN1cGVyKClcclxuXHJcbiAgICB0aGlzLndlYnNvY2tldCA9IHdlYnNvY2tldFxyXG5cclxuICAgIHRoaXMud2Vic29ja2V0Lm9uKFwiZXJyb3JcIiwgKGVycm9yOiBFcnJvcikgPT4gY29uc29sZS5lcnJvcihlcnJvcikpXHJcblxyXG4gICAgdGhpcy53ZWJzb2NrZXQub24oXCJjb25uZWN0aW9uXCIsIChzb2NrZXQ6IFdTLldlYlNvY2tldCwgcmVxKSA9PiB7XHJcbiAgICAgIE9iamVjdC5hc3NpZ24oc29ja2V0LCB7IHV1aWQ6IHV1aWR2NCgpIH0pO1xyXG5cclxuICAgICAgY29uc29sZS5sb2coYFxcblxcbuKcqCBOZXcgY2xpZW50OiAke3NvY2tldC51dWlkfSBmcm9tICR7cmVxLnNvY2tldC5yZW1vdGVBZGRyZXNzfWApXHJcblxyXG4gICAgICBzb2NrZXQub24oXCJjbG9zZVwiLCAoKSA9PiBjb25zb2xlLmxvZyhgQ2xpZW50ICR7c29ja2V0LnV1aWR9IGNsb3NlZCBjb25lY3Rpb24uYCkpXHJcblxyXG4gICAgICBzb2NrZXQub24oXCJtZXNzYWdlXCIsIChtZXNzYWdlOiBXUy5SYXdEYXRhKSA9PiB7XHJcbiAgICAgICAgbGV0IHBheWxvYWQ6IFBheWxvYWQgPSB7IHR5cGU6IFwiXCIsIG1zZzogdW5kZWZpbmVkIH07XHJcblxyXG4gICAgICAgIHRyeSB7XHJcbiAgICAgICAgICBwYXlsb2FkID0gTWFuYWdlci5kZWNvZGVQYXlsb2FkKG1lc3NhZ2UpO1xyXG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycm9yKTtcclxuICAgICAgICAgIHNvY2tldC5zZW5kKGBVbmtub3duIGNvbW1hbmQ6ICR7bWVzc2FnZS50b1N0cmluZygpfWApXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBzdXBlci5lbWl0KHBheWxvYWQudHlwZSwgcGF5bG9hZC5tc2csIHNvY2tldC51dWlkKVxyXG4gICAgICB9KVxyXG5cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzdGF0aWMgZGVjb2RlUGF5bG9hZChtZXNzYWdlOiBXUy5SYXdEYXRhKTogUGF5bG9hZCB7XHJcbiAgICBjb25zdCBwYXlsb2FkID0gSlNPTi5wYXJzZShtZXNzYWdlLnRvU3RyaW5nKCkpIGFzIFBheWxvYWQ7XHJcblxyXG4gICAgaWYgKHBheWxvYWQudHlwZSB8fCBwYXlsb2FkLnR5cGUgJiYgcGF5bG9hZC5tc2cpIHJldHVybiBwYXlsb2FkO1xyXG5cclxuICAgIHRocm93IG5ldyBFcnJvcihgV3JvbmcgcGF5bG9hZC4gRXhwZWN0ZWQge3R5cGU6IHN0cmluZywgbXNnOiBhbnl9IHJlY2l2ZWQ6IHske3BheWxvYWQudHlwZX0sICR7cGF5bG9hZC5tc2d9fWApXHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHN0YXRpYyBlbmNvZGVQYXlsb2FkKGRhdGE6IFBheWxvYWQpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KGRhdGEpXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kIGEgbWVzc2FnZSB0byBhbGwgY29ubmVjdGVkIGNsaWVudHNcclxuICAgKiBcclxuICAgKiBAZXhhbXBsZVxyXG4gICAqIG1hbmFnZXIuc2VuZEJyb2FkY2FzdChcIkNIQU5ORUxcIiwgeyBkYXRhOiBcInRlc3RcIiB9KVxyXG4gICAqL1xyXG4gIHNlbmRCcm9hZGNhc3Q8SyBleHRlbmRzIGtleW9mIFJlcz4odHlwZTogSywgbXNnOiBSZXNbS10sIHV1aWQ/OiBzdHJpbmcpIHtcclxuICAgIGNvbnN0IHBheWxvYWQgPSBNYW5hZ2VyLmVuY29kZVBheWxvYWQoeyB0eXBlOiB0eXBlIGFzIHN0cmluZywgbXNnIH0pO1xyXG5cclxuICAgIHRoaXMud2Vic29ja2V0LmNsaWVudHMuZm9yRWFjaCgoY2xpZW50KSA9PiB7XHJcbiAgICAgIGlmIChjbGllbnQudXVpZCA9PT0gdXVpZCkgcmV0dXJuO1xyXG5cclxuICAgICAgY2xpZW50LnNlbmQocGF5bG9hZClcclxuICAgIH0pXHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTZW5kIGEgbWVzc2FnZSB0byBzcGVjaWZpYyBjbGllbnQgYmFzZWQgaW4gVVVJRFxyXG4gICAqIFxyXG4gICAqIEBleGFtcGxlXHJcbiAgICogbWFuYWdlci5zZW5kKFwiQ0hBTk5FTFwiLCB7IGRhdGE6IFwidGVzdFwiIH0sIFwiVVVJRFwiKVxyXG4gICAqL1xyXG4gIHNlbmQ8SyBleHRlbmRzIGtleW9mIFJlcz4odHlwZTogSywgbXNnOiBSZXNbS10sIHV1aWQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgcGF5bG9hZCA9IE1hbmFnZXIuZW5jb2RlUGF5bG9hZCh7IHR5cGU6IHR5cGUgYXMgc3RyaW5nLCBtc2cgfSk7XHJcbiAgIFxyXG4gICAgY29uc3QgY2xpZW50ID0gQXJyYXkuZnJvbSh0aGlzLndlYnNvY2tldC5jbGllbnRzKS5maW5kKChjbGllbnQpID0+IGNsaWVudC51dWlkID09PSB1dWlkKTtcclxuXHJcbiAgICBpZiAoY2xpZW50KSB7XHJcbiAgICAgIGNsaWVudC5zZW5kKHBheWxvYWQpXHJcbiAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICByZXR1cm4gZmFsc2U7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBXYWl0IGZvciBtZXNzYWdlIGluIHNwYWNpZmljIGNoYW5uZWxcclxuICAgKiBcclxuICAgKiBAZXhhbXBsZVxyXG4gICAqIG1hbmFnZXIub24oXCJDSEFOTkVMXCIsIChjb250ZXh0OiBDb250ZXh0LCBtc2cpID0+IHZvaWQpXHJcbiAgICovXHJcbiAgb248SyBleHRlbmRzIGtleW9mIFJlcT4oZXZlbnROYW1lOiBLLCBsaXN0ZW5lcjogKGNvbnRleHQ6IENvbnRleHQ8UmVzPiwgbXNnOiBSZXFbS10pID0+IHZvaWQpIHtcclxuICAgIGNvbnN0IGNhbGxiYWNrID0gKG1zZzogYW55LCB1dWlkOiBzdHJpbmcpID0+IGxpc3RlbmVyKHtcclxuICAgICAgc2VuZEJyb2FkY2FzdDogKHR5cGUsIG1zZykgPT4gdGhpcy5zZW5kQnJvYWRjYXN0KHR5cGUsIG1zZywgdXVpZCksXHJcbiAgICAgIHNlbmQ6KHR5cGUsbXNnLHV1aWQpID0+ICB0aGlzLnNlbmQodHlwZSxtc2csdXVpZCksXHJcbiAgICAgIG9yaWdpbklkOiB1dWlkXHJcbiAgICB9LCBtc2cpO1xyXG5cclxuICAgIHJldHVybiBzdXBlci5vbihldmVudE5hbWUgYXMgc3RyaW5nLCBjYWxsYmFjayk7XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBNYW5hZ2VyO1xyXG4iXX0=
